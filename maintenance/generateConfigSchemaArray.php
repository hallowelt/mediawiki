<?php

use Wikimedia\StaticArrayWriter;

require_once __DIR__ . '/Maintenance.php';
require_once __DIR__ . '/includes/ConfigSchemaDerivativeTrait.php';

/**
 * Maintenance script that generates the PHP representation of the config-schema.yaml file.
 *
 * @ingroup Maintenance
 */
class GenerateConfigSchemaArray extends Maintenance {
	use ConfigSchemaDerivativeTrait;

	/** @var string */
	private const DEFAULT_OUTPUT_PATH = __DIR__ . '/../includes/config-schema.php';

	public function __construct() {
		parent::__construct();

		$this->addDescription( 'Generate an optimized config-schema.php file.' );

		$this->addOption(
			'output',
			'Path to output relative to $IP. Default: ' . self::DEFAULT_OUTPUT_PATH,
			false,
			true
		);
	}

	public function execute() {
		$schema = $this->loadSettingsSource();

		foreach ( $schema['config-schema'] as $key => &$value ) {
			unset( $value['description'] );
		}

		$content = ( new StaticArrayWriter() )->write(
			$schema,
			"This file is automatically generated using maintenance/generateConfigSchema.php.\n" .
			"phpcs:disable Generic.Files.LineLength"
		);

		$this->writeOutput( self::DEFAULT_OUTPUT_PATH, $content );
	}
}

$maintClass = GenerateConfigSchemaArray::class;
require_once RUN_MAINTENANCE_IF_MAIN;
